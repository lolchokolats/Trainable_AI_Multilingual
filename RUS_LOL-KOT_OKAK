import json
import os
import random

FILE = "broken_rus.json"

if os.path.exists(FILE):
    with open(FILE, "r", encoding="utf-8") as f:
        brain = json.load(f)
else:
    brain = {}

mode = "–Ω–æ—Äm–ª"
messages = 0
trainings = 0

def save():
    with open(FILE, "w", encoding="utf-8") as f:
        json.dump(brain, f, ensure_ascii=False, indent=2)

def clean(text):
    return text.lower().strip().replace("—ë","–µ").replace("–π","–∏")

def find_answer(phrase):
    wrds = phrase.split()
    cunter = {}
    for w in wrds:
        if w in brain:
            for ans, wei in brain[w].items():
                cunter[ans] = cunter.get(ans,0)+wei
    if not cunter:
        return None
    bst = max(cunter.values())
    cand = [a for a,v in cunter.items() if v==bst]
    return random.choice(cand)

def train(phrase, answer):
    global trainings
    for w in phrase.split():
        if w not in brain:
            brain[w] = {}
        brain[w][answer] = brain[w].get(answer,0)+1
    trainings +=1
    save()

def commands(text):
    global mode
    if text=="/help":
        print("üìå –∫–æ–º–∞–Ω–¥–∏–∫–∏:")
        print("/help ‚Äî –ø–º–º")
        print("/stats ‚Äî —Ü–∏—Ñ—Ä—ã")
        print("/mode ‚Äî —Ä–µ–∂–∏–º")
        print("/clear ‚Äî –æ—á–∏—Å—Ç –º–æ–∑–≥")
        return True
    if text=="/stats":
        print(f"üß† —Å–ª–æ–≤–µ—à–∫–∏: {len(brain)}")
        print(f"üí¨ –ø–æ—Å–ª–∞–Ω–∏—è: {messages}")
        print(f"üìö —É—á–µ–Ω—å–∫–∏: {trainings}")
        print(f"‚öôÔ∏è —Ä–µ–∂–∏–º: {mode}")
        return True
    if text=="/mode":
        mode = "—à—É—Ç–∫" if mode=="–Ω–æ—Ä–º–ª" else "–Ω–æ—Ä–º–ª"
        print(f"‚öôÔ∏è —Å–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞ ‚Üí {mode}")
        return True
    if text=="/clear":
        brain.clear()
        save()
        print("üóëÔ∏è –º–æ–∑–≥ –æ—á–∏—â–µ–Ω –±–≥–≥")
        return True
    return False

print("ü§ñ –ø–æ–ª–æ–º–∞–Ω–Ω—ã–π –ò–ò –∑–∞–ø—É—â–µ–Ω")
print("–Ω–∞–ø–∏—à–∏ /help —á—Ç–æ–± —É–∑–Ω–∞—Ç—å –∫–æ–º–∞–Ω–¥–∫–∏")

while True:
    inp = input("—Ç—ã: ")
    if inp.lower() in ["–≤—ã—Ö–æ–¥","exit"]:
        break
    inp = clean(inp)
    messages+=1
    if inp.startswith("/"):
        if commands(inp):
            continue
    ans = find_answer(inp)
    if ans:
        if mode=="—à—É—Ç–∫":
            ans+=" üòπ"
        print("–ò–ò:",ans)
    else:
        print("–ò–ò: —Ö–∑ —á—ë —ç—Ç–æ. –Ω–∞—É—á–∏ –ø–∂")
        new_ans=input("–æ—Ç–≤: ")
        train(inp,clean(new_ans))
        print("–ò–ò: –∑–∞–ø–æ–º–Ω–∏–ª, —Å—ä–µ–ª –º–æ–∑–≥–∏ —Ö—ç—ç—ç—Ö—ç—ç—ç—Öüß†")
